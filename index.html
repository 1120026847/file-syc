<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>即时剪贴板 – 多端文件同步</title>
  <meta name="color-scheme" content="light dark" />
  <style>
    :root{
      --bg: #0b0c10; --fg:#e8ebf0; --muted:#a5b0c2; --brand:#6aa6ff; --accent:#7ee787;
      --card:#14161c; --border: #262a33;
    }
    @media (prefers-color-scheme: light) {
      :root{ --bg:#f7f8fb; --fg:#111318; --muted:#586173; --brand:#2b6af6; --accent:#17b26a; --card:#fff; --border:#e5e7ee; }
    }
    *{ box-sizing: border-box; }
    html,body{ height:100%; }
    body{
      margin:0; background:var(--bg); color:var(--fg);
      font: 16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "SF Pro", sans-serif;
      display:flex; align-items:center; justify-content:center; padding:24px;
    }
    .app{ width:min(980px, 100%); }
    .header{
      display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap; margin-bottom:16px;
    }
    .title{ font-weight:700; font-size:20px; letter-spacing:.2px; display:flex; align-items:center; gap:8px; }
    .badge{ padding:2px 8px; border-radius:999px; background:var(--card); border:1px solid var(--border); color:var(--muted); font-size:12px;}
    .room{
      display:flex; gap:8px; width:100%; max-width:520px;
    }
    .input{ flex:1; padding:10px 12px; border-radius:12px; border:1px solid var(--border); background:var(--card); color:var(--fg); outline:none; }
    .btn{
      appearance:none; border:1px solid var(--border); background:var(--card); color:var(--fg);
      padding:10px 14px; border-radius:12px; cursor:pointer; transition:.2s transform, .2s opacity, .2s background;
    }
    .btn:hover{ transform:translateY(-1px); }
    .btn.primary{ background:var(--brand); border-color:transparent; color:#fff; }
    .btn.ghost{ background:transparent; }
    .grid{ display:grid; grid-template-columns:1fr; gap:16px; }
    @media(min-width:800px){ .grid{ grid-template-columns: 1fr 1fr; } }
    .card{
      border:1px solid var(--border); background:var(--card); border-radius:16px; padding:16px;
    }
    .drop{
      display:flex; align-items:center; justify-content:center; text-align:center;
      min-height:200px; border:1.5px dashed var(--border); border-radius:16px; background:rgba(127,127,127,.04);
      padding:16px; transition: .12s border-color, .12s background;
    }
    .drop.dragover{ border-color:var(--brand); background:rgba(64,128,255,.08); }
    .muted{ color:var(--muted); }
    .list{ display:flex; flex-direction:column; gap:10px; max-height:340px; overflow:auto; padding-right:4px; }
    .item{
      display:flex; align-items:center; gap:10px; justify-content:space-between; padding:10px; border:1px solid var(--border); border-radius:12px; background:rgba(127,127,127,.04);
    }
    .name{ overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .actions{ display:flex; gap:6px; flex-wrap:wrap; }
    .small{ font-size:12px; }
    .footer{ margin-top:8px; display:flex; gap:8px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
    .link{ font-weight:600; color:var(--brand); text-decoration:none; word-break:break-all; }
  </style>
</head>
<body>
  <div class="app">
    <div class="header">
      <div class="title">即时剪贴板 <span class="badge">跨设备 · 无需登录</span></div>
      <div class="room">
        <input id="alias" class="input" placeholder="设置你的专属地址（如：zhangsan）" />
        <button class="btn" id="set-alias">跳转</button>
        <button class="btn" id="copy-link">复制当前链接</button>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div id="drop" class="drop">
          <div>
            <div style="font-weight:700;margin-bottom:6px;">拖拽 / 粘贴 / 选择文件，同步到当前地址</div>
            <div class="muted small">支持多文件。也可点击下方按钮选择本地文件。</div>
            <div style="margin-top:12px;">
              <input id="picker" type="file" multiple style="display:none;" />
              <button class="btn primary" id="pick-btn">选择文件上传</button>
              <button class="btn ghost" id="refresh-btn">刷新列表</button>
            </div>
          </div>
        </div>
        <div class="footer small muted">
          <div>当前地址：<a id="share" class="link" href="#"></a></div>
          <div>提示：每次上传会覆盖并删除旧文件（节省 Blob 空间）。</div>
        </div>
      </div>

      <div class="card">
        <div style="font-weight:700;margin-bottom:8px;">已上传文件</div>
        <div id="list" class="list">
          <div class="muted small">暂无文件，上传后会显示在这里。</div>
        </div>
      </div>
    </div>
  </div>

<script>
(function(){
  'use strict';

  // ---------- 路由 / 房间 ----------
  function randId(n){ var s='abcdefghijklmnopqrstuvwxyz', r=''; for(var i=0;i<n;i++){ r+=s[Math.floor(Math.random()*s.length)]; } return r; }
  var isRoot = (location.pathname === '/' || location.pathname === '');
  if(isRoot){
    var id = randId(5);
    location.replace('/' + id);
    return; // 结束本轮脚本，避免后续运行在旧路径上
  }
  var ROOM = decodeURIComponent(location.pathname.replace(/^\//,''));
  var origin = location.origin || (location.protocol + '//' + location.host);
  var roomUrl = origin + '/' + encodeURIComponent(ROOM);

  // ---------- 顶部交互 ----------
  var shareEl = document.getElementById('share');
  var copyLinkBtn = document.getElementById('copy-link');
  var aliasInput = document.getElementById('alias');
  var setAliasBtn = document.getElementById('set-alias');
  if(shareEl){ shareEl.textContent = roomUrl; shareEl.href = roomUrl; }

  if(copyLinkBtn){
    copyLinkBtn.addEventListener('click', function(){
      if(navigator.clipboard && navigator.clipboard.writeText){
        navigator.clipboard.writeText(roomUrl).then(function(){
          copyLinkBtn.textContent = '已复制';
          setTimeout(function(){ copyLinkBtn.textContent = '复制当前链接'; }, 1000);
        });
      }else{
        // 兼容非常老的环境
        window.prompt('复制当前链接', roomUrl);
      }
    });
  }

  if(setAliasBtn){
    setAliasBtn.addEventListener('click', function(){
      var v = (aliasInput.value || '').trim().replace(/\s+/g,'-').toLowerCase();
      if(!v) return;
      location.href = '/' + encodeURIComponent(v);
    });
  }

  // ---------- 上传与列表 ----------
  var drop = document.getElementById('drop');
  var picker = document.getElementById('picker');
  var pickBtn = document.getElementById('pick-btn');
  var refreshBtn = document.getElementById('refresh-btn');
  var listEl = document.getElementById('list');

  function stop(e){ if(e){ e.preventDefault(); e.stopPropagation(); } }
  if(drop){
    ['dragenter','dragover','dragleave','drop'].forEach(function(ev){
      drop.addEventListener(ev, stop, false);
    });
    drop.addEventListener('dragover', function(){ drop.classList.add('dragover'); });
    drop.addEventListener('dragleave', function(){ drop.classList.remove('dragover'); });
    drop.addEventListener('drop', function(e){
      drop.classList.remove('dragover');
      var fl = (e && e.dataTransfer && e.dataTransfer.files) ? Array.prototype.slice.call(e.dataTransfer.files) : [];
      if(fl.length) uploadFiles(fl);
    });
  }

  document.addEventListener('paste', function(e){
    var fl = (e && e.clipboardData && e.clipboardData.files) ? Array.prototype.slice.call(e.clipboardData.files) : [];
    if(fl.length) uploadFiles(fl);
  });

  if(pickBtn && picker){
    pickBtn.addEventListener('click', function(){ picker.click(); });
    picker.addEventListener('change', function(){
      var fl = Array.prototype.slice.call(picker.files || []);
      if(fl.length) uploadFiles(fl);
      picker.value = '';
    });
  }

  if(refreshBtn){ refreshBtn.addEventListener('click', listFiles); }

  function fmtSize(n){
    if(typeof n !== 'number') return '';
    var u=['B','KB','MB','GB'], i=0, x=n;
    while(x>=1024 && i<u.length-1){ x/=1024; i++; }
    return (i ? x.toFixed(1) : Math.round(x)) + u[i];
  }

  function uploadFiles(files){
    var form = new FormData();
    for(var i=0;i<files.length;i++){ form.append('file', files[i], files[i].name); }
    var oldTxt = pickBtn ? pickBtn.textContent : '';
    if(pickBtn){ pickBtn.textContent = '上传中…'; pickBtn.disabled = true; }

    fetch('/api/upload?room='+encodeURIComponent(ROOM), { method:'POST', body: form })
      .then(function(res){
        if(!res.ok){ return res.text().then(function(t){ throw new Error(t || res.status); }); }
        return res.json();
      })
      .then(function(){ listFiles(); })
      .catch(function(err){
        alert('上传失败：' + err.message + '\n提示：Server Upload 单次请求体上限约 4.5MB。');
      })
      .finally(function(){
        if(pickBtn){ pickBtn.textContent = oldTxt; pickBtn.disabled = false; }
      });
  }

  function listFiles(){
    fetch('/api/list?room='+encodeURIComponent(ROOM))
      .then(function(res){ return res.json(); })
      .then(function(data){
        var files = (data && data.files) ? data.files : [];
        if(!listEl) return;
        if(!files.length){
          listEl.innerHTML = '<div class="muted small">暂无文件</div>';
          return;
        }
        listEl.innerHTML = '';
        files.forEach(function(f){
          var row = document.createElement('div'); row.className='item';
          var left = document.createElement('div'); left.style.flex='1';
          var name = (f.pathname || '').split('/').pop();
          var ct = f.contentType || '';
          var size = (typeof f.size === 'number') ? fmtSize(f.size) : '';
          left.innerHTML = '<div class="name">'+ name +'</div><div class="muted small">'+ ct+' · '+size +'</div>';

          var actions = document.createElement('div'); actions.className='actions';

          var btnCopyLink = document.createElement('button'); btnCopyLink.className='btn small'; btnCopyLink.textContent='复制链接';
          btnCopyLink.addEventListener('click', function(){
            if(navigator.clipboard && navigator.clipboard.writeText){
              navigator.clipboard.writeText(f.url);
              btnCopyLink.textContent='已复制';
              setTimeout(function(){ btnCopyLink.textContent='复制链接'; }, 800);
            }else{
              window.prompt('复制该链接', f.url);
            }
          });

          var aDownload = document.createElement('a'); aDownload.className='btn small'; aDownload.textContent='下载';
          aDownload.href = f.downloadUrl || f.url; aDownload.download = '';

          actions.appendChild(btnCopyLink);
          actions.appendChild(aDownload);

          // 尝试复制“文件本体”到系统剪贴板（仅在支持 ClipboardItem 的浏览器工作）
          if(window.ClipboardItem && navigator.clipboard && navigator.clipboard.write){
            var btnCopyFile = document.createElement('button'); btnCopyFile.className='btn small'; btnCopyFile.textContent='复制文件';
            btnCopyFile.addEventListener('click', function(){
              fetch(f.url).then(function(r){ return r.blob(); }).then(function(b){
                var data = {}; data[b.type || 'application/octet-stream'] = b;
                return navigator.clipboard.write([ new ClipboardItem(data) ]);
              }).then(function(){
                btnCopyFile.textContent='已复制';
                setTimeout(function(){ btnCopyFile.textContent='复制文件'; }, 800);
              }).catch(function(){ alert('浏览器不支持把该类型写入剪贴板'); });
            });
            actions.appendChild(btnCopyFile);
          }

          row.appendChild(left);
          row.appendChild(actions);
          listEl.appendChild(row);
        });
      })
      .catch(function(){
        if(listEl){ listEl.innerHTML = '<div class="muted small">加载失败</div>'; }
      });
  }

  // 初次渲染 + 轮询“同步”
  listFiles();
  setInterval(listFiles, 3000);
})();
</script>
</body>
</html>
